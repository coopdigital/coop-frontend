{% import '/macros/components/buttons.html' as button %}

{% macro appContent(content, cms, config) %}

  <div class="coop-c-app-download__content coop-u-clearfix">
    {% if content.heading %}
      <h2 class="coop-c-app-download__title">{{content.heading|safe}}</h2>
    {% endif %}
    {% if content.bodyText %}
    <div class="coop-c-app-download__body">
      {{content.bodyText|markdown}}
    </div>
    {% endif %}
    
    {% if content.appStoreLink or content.googlePlayLink %}
      <div class="coop-c-app-download__btns coop-u-clearfix">
        {% if content.appStoreLink %}
          <!-- App Store button -->
          {% with appStoreLink = cms.get_entry(content.appStoreLink.sys.id) %}
            {{button.apple(appStoreLink)}}
          {% endwith %}
        {% endif %}

        {% if content.googlePlayLink %}
          <!-- Google Play button -->
          {% with googlePlayLink = cms.get_entry(content.googlePlayLink.sys.id) %}
            {{button.googlePlay(googlePlayLink)}}
          {% endwith %}
        {% endif %}
      </div>
    {% endif %}
    {% if content.link and config.appMiniVersion != true %}
      {% with link = cms.get_entry(content.link.sys.id) %}
        {%- set href = {} -%}
        {% if link.type == 'internalLink' %}
          {% if link.data.fields.page %}
            {% with internalLink = cms.get_entry(link.data.fields.page.sys.id) %}
              {%- set _ = href.update({"url" : tenant_url_path + internalLink.full_url_path}) -%}
            {% endwith %}
        {% endif %}
        {% else %}
          {%- set _ = href.update({"url" : link.fields.url.data }) -%}
        {% endif %}
        <div class="coop-c-app-download__about">
          <p>
            <a class="coop-t-link coop-t-link--arrow" href="{{href.url}}" data-contenttype="App download" data-contentparent="{{content.heading}}" data-linktext="{{link.fields.title.data}}">
              {{link.fields.title.data|safe}}<svg class="coop-t-link__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 20" aria-hidden="true" focusable="false"><path class="coop-u-brand-membership-turquoise-bright-fill" d="M13.89 0L11.4 2.46l5.87 5.8H0v3.48h17.28l-5.88 5.8L13.89 20 24 10z" stroke="none"/></svg></a>
          </p>
        </div>
      {% endwith %}
    {% endif %}
  </div>
{% endmacro %}

{% macro appImage(config) %}
  {% if config.alignBottom %}
    {% set imageAlignClass = 'coop-c-app-download__media--align-bottom' %}
  {% else %}
    {% set imageAlignClass = 'coop-c-app-download__media--align-top' %}
  {% endif %}
  {% set strokeClass = ' coop-u-brand-membership-turquoise-bright-stroke' %}
  {% if config.customHtml == true %}
    {% set strokeClass = '' %}
  {% endif %}
  <figure class="coop-c-app-download__media {{imageAlignClass}}{{strokeClass}}">
    <picture class="coop-c-app-download__picture {% if config.handsetImage == true %}coop-c-app-download__picture--handset{% endif %}">
      <!-- if browser supports webp image format, serve the webp format-->
      <source media="(min-width: 48em)" srcset="{{ config.imageUrl }}?fm=webp&amp;q=60 1x, {{ config.imageUrl }}?fm=webp&amp;q=60 2x" type="image/webp" />
      <source srcset="{{ config.imageUrl }}?fm=webp&amp;q=60 1x, {{ config.imageUrl }}?fm=webp&amp;q=60 2x" type="image/webp" />
      <!-- if no webp supported then default to transparent PNG -->
      <source media="(min-width: 48em)" srcset="{{config.imageUrl}}?fm=png&amp;q=60 1x, {{config.imageUrl}}?fm=png&amp;q=60 2x" type="image/png">
      <source srcset="{{config.imageUrl}}?fm=png&amp;q=60 1x, {{config.imageUrl}}?fm=png&amp;q=60 2x" type="image/png">
      <!-- fallback -->
      <img class="coop-c-app-download__image" src="{{ config.imageUrl }}" alt="{{config.altText}}">
    </picture>
  </figure>
{% endmacro %}

{% macro render(content, cms, config) %}
  {%- set backgroundColour = '' -%}
  {%- if content.background and content.background.class -%}
      {%- set backgroundColour = content.background.class -%}
  {%- endif -%}
  
  {% set appMiniVersion = false %}
  {% if content.miniVersion == true %}
    {% set appMiniVersion = true %}
  {% endif %}
  
  {% set config = {
    'appMiniVersion' : appMiniVersion
  } %}
  
  {% if config.appMiniVersion != true %}
    {%- set imageConfig = {} -%}
    {% with image = cms.get_asset(content.image.sys.id) %}
      {% if image.data.fields.description %}
          {% set altText = image.data.fields.description %}
      {% else %}
          {% set altText = image.data.fields.title %}
      {% endif %}
      
      {% set _ = imageConfig.update({
        'imageUrl'       : image.data.fields.file.url,
        'altText'        : altText,
        'width'          : image.data.fields.file.details.image.width,
        'height'         : image.data.fields.file.details.image.height,
        'handsetImage'   : content.handsetImage
      }) %}
    {% endwith %}
  {% endif %}

  <aside id="app_{{content.heading.replace(' ','_')}}" class="coop-c-app-download {{backgroundColour}} {% if config.appMiniVersion == true %} coop-c-app-download--mini{% endif %}">
    <div class="coop-c-app-download__inner coop-u-clearfix">
      {% if config.appMiniVersion == true %}
        {{ appContent(content,cms,config) }}
      {% else %}
        {% if content.imagePositionRight == true %}
          {{ appContent(content,cms,config) }}
          {{ appImage(imageConfig) }}
        {% else %}
          {{ appImage(imageConfig) }}
          {{ appContent(content,cms,config) }}
        {% endif %}
      {% endif %}
    </div>
  </aside>
{% endmacro %}

{% macro customHtml(content, config='') %}
  {% set imageConfig = {
    'imageUrl'         : content.image,
    'backgroundclass'  : content.imagebackgroundclass,
    'altText'          : content.imagealttext,
    'width'            : content.imagewidth|int,
    'height'           : content.imageheight|int,
    'alignBottom'      : content.alignimagebottom,
    'customHtml'       : true
  }  %}
  <aside class="coop-c-app-download {{ content.backgroundclass}}">
    <div class="coop-c-app-download__inner coop-u-clearfix">
      {% if content.alignimageleft == true %}
        {{ appImage(imageConfig) }}
      {% endif %}
      <div class="coop-c-app-download__content coop-u-clearfix">
        <h2 class="coop-c-app-download__title">{{ content.title}}</h2>
        {% if content.downloadbodytext %}
          <div class="coop-c-app-download__body">
            {{ content.downloadbodytext|safe}}
          </div>
        {% endif %}
        {% if content.downloadabout %}
          <div class="coop-c-app-download__about">
            {{ content.downloadabout|safe}}
          </div>
        {% endif %}
      </div>
      {% if content.alignimageleft != true %}
        {{ appImage(imageConfig) }}
      {% endif %}
    </div>
  </aside>
{% endmacro %}